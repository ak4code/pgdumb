# PgDumb - Редактор дампов PostgreSQL в собственном формате

[![Python](https://img.shields.io/badge/python-3.7%2B-blue)](https://www.python.org/downloads/)

Этот скрипт на Python позволяет читать, анализировать и модифицировать дампы баз данных PostgreSQL, созданные утилитой `pg_dump` в **собственном (custom) формате** (опция `-Fc`).

## Возможности

*   **Парсинг**: Чтение и разбор структуры дампа, включая заголовок, таблицу содержимого (TOC) и сами данные.
*   **Анализ**: Получение метаданных дампа (версия PostgreSQL, дата создания, метод сжатия) и информации о записях TOC.
*   **Модификация**: Поиск определенных блоков данных (например, данных таблиц) и возможность их изменения.
*   **Перепаковка**: Запись модифицированного дампа обратно в собственный формат с сохранением структуры и корректной обработкой сжатия.

## Установка

Для работы скрипта требуется Python 3.7 или выше. Дополнительные библиотеки не требуются, так как используются только стандартные модули.

Просто скопируйте файл `pgdumb.py` (или как вы его назвали) в нужную директорию.

## Использование

Скрипт предназначен для работы с потоками ввода/вывода, что делает его удобным для использования в конвейерах (pipes).

**Базовый пример:**

```bash
pg_dump -U <username> -h <ip_host> -Fc -d <db_name> | python pgdumb.py  > output.dump
```

**Как это работает:**

1.  Исходный дамп подается на стандартный ввод скрипта (`sys.stdin.buffer`).
2.  Скрипт парсит дамп и загружает его в память.
3.  (В текущем примере) Находятся блоки данных таблиц (`TABLE DATA`), в них заменяются все вхождения слова `row` на `xxxx`.
4.  Модифицированные данные перепаковываются с учетом оригинального метода сжатия.
5.  Результирующий дамп выводится в стандартный вывод (`sys.stdout.buffer`).

**Настройка модификаций:**

Функция `modify_data_block` в скрипте содержит пример логики изменения данных. Вы можете изменить её под свои нужды.

```python
def modify_data_block(data: bytes) -> bytes:
    # data - это байты несжатых данных блока
    text_data = data.decode('utf-8')
    # Пример: заменить 'row' на 'xxxx'
    modified_text = text_data.replace('row', 'xxxx')
    return modified_text.encode('utf-8')
```

## Поддерживаемые версии формата

Скрипт поддерживает чтение и запись дампов различных версий формата Custom, включая изменения, внесенные в PostgreSQL 9.0, 11, 12, 16 и 17.

## Важные замечания

*   **Целостность**: Скрипт предполагает, что входной поток является корректным дампом в собственном формате. Поврежденные дампы могут привести к ошибкам.
*   **Потоковая обработка**: Хотя скрипт читает весь входной поток в память, логика обработки построена с учетом структуры дампа. Для очень больших дампов это может потреблять значительный объем памяти.
*   **Сжатие**: Обработка сжатия (gzip, zlib) реализована, но не все детали оригинального формата могут быть учтены (например, гранулярность сжатия внутри блоков).
*   **Модификация**: Текущий пример показывает простую замену текста. Более сложные изменения (например, добавление/удаление строк) требуют понимания внутренней структуры данных таблиц в дампе.

## Лицензия

Этот проект распространяется по лицензии MIT. См. файл `LICENSE` для подробностей.

